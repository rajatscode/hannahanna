# Hannahanna v0.5: Template Management & Enhanced Features

**Release Date:** 2025-01-12
**Theme:** Template management, workflow enhancements, comprehensive testing
**Status:** âœ… IMPLEMENTED
**Test Coverage:** 463/463 tests passing (100%)

---

## Implementation Summary

v0.5 successfully delivered all planned features including template management, workspace save/restore, resource tracking, and comprehensive testing improvements. This release includes ONE BREAKING CHANGE (environment variable rename) but provides clear migration path.

**Implementation Highlights:**
- âœ… All features implemented as specified
- âœ… 100% test pass rate (463 tests)
- âœ… Comprehensive documentation (templates.md, MIGRATING.md, release notes)
- âœ… Critical workspace save/restore bug fixed during testing
- âš ï¸ Breaking change: WT_* â†’ HNHN_* environment variables

**Key Deliverables:**
- Template management commands (create, list, show)
- Template file copying with variable substitution
- Workspace save/restore/list/delete/export
- Resource tracking (hn stats)
- 36 comprehensive hook tests (exceeds 35+ requirement)
- 35 comprehensive Docker tests (meets 35+ requirement)
- Complete migration guide and release notes

**See:**
- [RELEASE_NOTES_v0.5.md](../RELEASE_NOTES_v0.5.md) - Complete release notes
- [docs/templates.md](../docs/templates.md) - Template guide
- [docs/MIGRATING.md](../docs/MIGRATING.md) - Migration guide

---

## Original Specification

Below is the original v0.5 specification (preserved for reference).

---

## Executive Summary

v0.5 builds on v0.4's performance foundation by delivering the deferred template management features, enhanced workflow capabilities, and comprehensive testing improvements. This release focuses on user-facing features that improve the daily development workflow.

**Key Principle:** Incremental value delivery. Ship features that users are asking for while maintaining high quality standards.

---

## What's In Scope for v0.5

### 0. ğŸ› Critical Fix: Environment Variable Naming (Highest Priority)

**Problem:** Hook environment variables still use old "WT_" prefix from when the tool was called "wt"

**Current (WRONG):**
- `$WT_NAME`
- `$WT_PATH`
- `$WT_BRANCH`
- `$WT_COMMIT`
- `$WT_STATE_DIR`

**Should be:**
- `$HNHN_NAME`
- `$HNHN_PATH`
- `$HNHN_BRANCH`
- `$HNHN_COMMIT`
- `$HNHN_STATE_DIR`

**Rationale for HNHN_ prefix:**
- Avoids collision with Hacker News CLI tools (which might use HN_*)
- More unique and less likely to conflict with other tools
- Clearly identifies these as "Hannahanna" variables

**Implementation Strategy (Clean Break - No Backward Compatibility):**

**Simple approach:** Just replace WT_* with HNHN_* in v0.5
```rust
// Set ONLY the new HNHN_* variables
env.insert("HNHN_NAME".to_string(), worktree.name.clone());
env.insert("HNHN_PATH".to_string(), worktree.path.to_string_lossy().to_string());
env.insert("HNHN_BRANCH".to_string(), worktree.branch.clone());
env.insert("HNHN_COMMIT".to_string(), worktree.commit.clone());
env.insert("HNHN_STATE_DIR".to_string(), worktree.state_dir.to_string_lossy().to_string());
// No WT_* variables - clean break
```

**Why this is fine:**
- Users are smart enough to update their hooks
- Simple find/replace: `WT_` â†’ `HNHN_`
- Cleaner codebase without legacy cruft
- No complex deprecation warnings needed

**Files to change:**
- `src/hooks.rs` - Update `build_env()` function
- `README.md` - Update all documentation
- `docs/hooks.md` - Update examples (if exists)
- All example configs in repo
- Add detection for old variable usage (helpful warning)

**Tests to add:**
- Verify HNHN_* variables are set correctly
- Verify hook execution with new variables
- Verify all hook types use new variables

**Migration Guide Entry:**
```markdown
## v0.5.0: Environment Variable Renaming (BREAKING CHANGE)

Hook environment variables have been renamed from `WT_*` to `HNHN_*`.

**Why HNHN_?**
- Avoids collision with Hacker News CLI tools (HN_*)
- More unique prefix for Hannahanna-specific variables
- Clear identification of variable source

**Breaking Change:**
Old `WT_*` variables are **no longer set**. You MUST update your hooks.

**Migration:**
Simple find/replace in your hook configurations:
- `$WT_NAME` â†’ `$HNHN_NAME`
- `$WT_PATH` â†’ `$HNHN_PATH`
- `$WT_BRANCH` â†’ `$HNHN_BRANCH`
- `$WT_COMMIT` â†’ `$HNHN_COMMIT`
- `$WT_STATE_DIR` â†’ `$HNHN_STATE_DIR`

**Example:**
```bash
# Old (v0.4 and earlier) - NO LONGER WORKS
echo "Creating worktree: $WT_NAME"

# New (v0.5+) - REQUIRED
echo "Creating worktree: $HNHN_NAME"
```

**Quick migration command:**
```bash
# Update all .hannahanna.yml files in your repos
find . -name '.hannahanna*.yml' -exec sed -i 's/\$WT_/\$HNHN_/g' {} \;
```
```

**Acceptance Criteria:**
- [ ] All hooks receive only HNHN_* variables (no WT_*)
- [ ] All documentation updated to show HNHN_* variables
- [ ] Migration guide entry added with find/replace commands
- [ ] 5+ tests verifying HNHN_* variables

**Estimated Effort:** 0.5 days (much simpler without backward compat)

**Priority:** Ship this FIRST in v0.5 before other features

---

### 1. ğŸ“‹ Template Management (High Priority)

**Problem:** Users can use templates via `hn add --template <name>`, but can't discover what templates exist or create new ones easily.

**Solution:** Complete template management system with discovery and creation tools.

#### `hn templates list`
**Status:** ğŸŸ¢ Infrastructure exists (src/templates.rs has `list_templates()`)

Display available templates with descriptions and configuration details.

**Implementation:**
- Use existing `list_templates()` function from src/templates.rs
- Create new CLI command in src/cli/templates.rs
- Add to main.rs command dispatch

**Output:**
```bash
$ hn templates list

Available Templates
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
microservice   â”‚ Backend microservice with Docker
frontend       â”‚ React/Vue frontend setup
experiment     â”‚ Minimal config for quick experiments
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
3 templates found in .hn-templates/

Usage: hn add <name> --template <template-name>
```

**Detailed view:**
```bash
$ hn templates show microservice

Template: microservice
Description: Backend microservice with Docker
Location: .hn-templates/microservice/

Configuration:
  Docker: enabled
  Ports: app:3000, db:5432
  Hooks: post_create (npm install && npm run migrate)
  Sparse: services/api/, libs/shared/
```

**Features:**
- List all templates in .hn-templates/
- Show description from README.md or .hannahanna.yml
- Display key config settings
- `--json` output for scripting

**Tests:**
- List templates in directory
- Show template details
- Handle missing templates directory
- JSON output format

**Files to create/modify:**
- `src/cli/templates.rs` (new file, ~200 lines)
- `src/main.rs` (add templates subcommand)
- `tests/integration/templates_test.rs` (new, ~100 lines)

**Acceptance Criteria:**
- [ ] `hn templates list` shows all templates
- [ ] `hn templates show <name>` displays template details
- [ ] Empty directory shows helpful message
- [ ] JSON output works for scripting
- [ ] 10+ tests covering all scenarios

#### `hn templates create <name>`
**Status:** ğŸŸ¡ New feature

Interactive wizard to create new templates from scratch or from current worktree.

**Implementation:**
```bash
$ hn templates create microservice

Creating template 'microservice'
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Description: Backend microservice with Docker
2. Create from:
   [1] Scratch (empty template)
   [2] Current worktree (copy config)
   > 2

3. Include Docker config? [Y/n] y
4. Include hooks? [Y/n] y
5. Include sparse checkout paths? [y/N] n

Creating template at .hn-templates/microservice/...
âœ“ Created .hannahanna.yml
âœ“ Created README.md

Template 'microservice' created successfully!

Next steps:
  - Edit .hn-templates/microservice/.hannahanna.yml
  - Add description to README.md
  - Use with: hn add <name> --template microservice
```

**Features:**
- Interactive prompts using `dialoguer` crate (already a dependency)
- Create from scratch or copy from current worktree config
- Auto-generate README.md with template description
- Validate template name (no special chars)

**Tests:**
- Create template from scratch
- Create template from current worktree
- Invalid template names
- Existing template error

**Files:**
- `src/cli/templates.rs` (extend, +150 lines)
- Add `dialoguer` usage (already in dependencies)

**Acceptance Criteria:**
- [ ] Interactive creation works
- [ ] Can create from scratch
- [ ] Can create from current worktree
- [ ] Generates valid .hannahanna.yml
- [ ] Creates README.md with description
- [ ] 8+ tests

#### Template File Copying (Advanced)
**Status:** ğŸŸ¡ New feature

Allow templates to include actual files that get copied to new worktrees.

**Current:** Templates only override config
**New:** Templates can include files/directories to copy

**Example structure:**
```
.hn-templates/microservice/
â”œâ”€â”€ .hannahanna.yml       # Config overrides
â”œâ”€â”€ README.md             # Template description
â””â”€â”€ files/                # Files to copy (NEW)
    â”œâ”€â”€ .env.example
    â”œâ”€â”€ docker-compose.override.yml
    â””â”€â”€ scripts/
        â””â”€â”€ setup.sh
```

**Implementation:**
- Add `copy_template_files()` function to src/templates.rs
- Copy files/ directory contents to worktree root after creation
- Support variable substitution in copied files (${WORKTREE_NAME}, etc.)
- Run during `hn add` after config application

**Config:**
```yaml
# .hn-templates/microservice/.hannahanna.yml
template:
  copy_files: true
  variables:
    SERVICE_NAME: "${WORKTREE_NAME}"
    PORT: "${PORT_APP}"
```

**Tests:**
- Copy files from template
- Variable substitution in copied files
- Nested directory copying
- Skip copying if copy_files: false

**Files:**
- `src/templates.rs` (extend, +100 lines)
- Update `src/cli/add.rs` to call copy_template_files()

**Acceptance Criteria:**
- [ ] Files copied from template files/ directory
- [ ] Variable substitution works
- [ ] Nested directories copied correctly
- [ ] 6+ tests

**Estimated Effort:**
- `templates list`: 2 days
- `templates create`: 3 days
- File copying: 3 days
- **Total: 8 days**

---

### 2. ğŸ§ª Comprehensive Hook & Docker Testing (High Priority)

**Problem:** Current hook and Docker integration has basic coverage but lacks comprehensive edge case testing.

**Current Coverage:**
- Basic hook execution tests exist
- Docker integration tests exist
- BUT: Missing timeout tests, failure handling, complex scenarios

**What to Add:**

#### Hook Testing
- Hook timeout behavior (Windows vs Unix)
- Hook failure during worktree creation (rollback verification)
- Conditional hook execution across all hook types
- Hook environment variable validation
- Multiple hooks in sequence
- Hook stdout/stderr capture

**New tests:**
```rust
// tests/integration/hooks_comprehensive.rs

#[test]
fn test_hook_timeout_behavior() { }

#[test]
fn test_hook_failure_rollback() { }

#[test]
fn test_all_hook_types_with_conditions() { }

#[test]
fn test_hook_env_vars_correctness() { }

#[test]
fn test_multiple_conditional_hooks_same_branch() { }
```

#### Docker Testing
- Port allocation edge cases (exhaustion, conflicts)
- Docker container health check timeouts
- Multiple service orchestration
- Orphaned container cleanup verification
- Stats filtering accuracy (current fix needs tests)
- Compose override generation with all config options

**New tests:**
```rust
// tests/integration/docker_comprehensive.rs

#[test]
fn test_port_allocation_exhaustion() { }

#[test]
fn test_docker_stats_filtering_by_project() { }

#[test]
fn test_health_check_timeout() { }

#[test]
fn test_orphaned_container_cleanup() { }

#[test]
fn test_compose_override_all_options() { }
```

**Files:**
- `tests/integration/hooks_comprehensive.rs` (new, ~300 lines)
- `tests/integration/docker_comprehensive.rs` (new, ~400 lines)

**Acceptance Criteria:**
- [ ] 15+ new hook tests covering all edge cases
- [ ] 20+ new Docker tests covering all scenarios
- [ ] All tests pass
- [ ] No flaky tests
- [ ] Test coverage for v0.4 bug fixes (orphan protection, reparenting, stats filtering)

**Estimated Effort:** 5 days

---

### 3. ğŸ’¾ Workflow State Management (Medium Priority)

**Problem:** Users work on multiple worktrees but can't easily save/restore workspace states.

**Use Case:**
```bash
# Friday afternoon - multiple worktrees active
hn list
# feature-api     (RUNNING, :3000)
# feature-ui      (RUNNING, :3001)
# bugfix-auth     (RUNNING, :3002)

# Save current workspace state
hn workspace save friday-work

# Monday morning - restore everything
hn workspace restore friday-work
# Automatically starts Docker for all saved worktrees
```

**Implementation:**

#### `hn workspace save <name>`
Save current workspace state including:
- List of active worktrees
- Docker running/stopped status
- Port allocations
- Current worktree

**Storage:** `.hn-state/workspaces/<name>.yml`
```yaml
name: friday-work
saved_at: 2025-01-15T17:30:00Z
current_worktree: feature-api
worktrees:
  - name: feature-api
    docker_running: true
    ports: { app: 3000, db: 5432 }
  - name: feature-ui
    docker_running: true
    ports: { app: 3001 }
  - name: bugfix-auth
    docker_running: false
```

#### `hn workspace restore <name>`
Restore saved state:
- Start Docker containers for worktrees that were running
- Switch to the saved current worktree
- Show summary of restored state

#### `hn workspace list`
List saved workspace states

#### `hn workspace delete <name>`
Delete saved workspace state

**Tests:**
- Save workspace state
- Restore workspace state
- Docker containers restarted correctly
- Handle missing worktrees gracefully
- List saved workspaces
- Delete workspace state

**Files:**
- `src/cli/workspace.rs` (new, ~300 lines)
- `tests/integration/workspace_test.rs` (new, ~150 lines)

**Acceptance Criteria:**
- [ ] Save workspace state
- [ ] Restore workspace with Docker
- [ ] Handle missing worktrees gracefully
- [ ] 10+ tests

**Estimated Effort:** 4 days

---

### 4. ğŸ“Š Resource Usage Tracking (Low Priority)

**Problem:** Users want to see disk usage and resource consumption across worktrees.

**Enhancement to `hn info`:**
Already shows disk usage for one worktree. Enhance with:
- Memory usage over time (simple tracking)
- CPU usage tracking
- Network I/O (if Docker running)

**New command: `hn stats [name]`**
```bash
$ hn stats feature-api

Worktree: feature-api
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Disk Usage:    2.3 GB (worktree: 1.1 GB, state: 1.2 GB)
Docker Memory: 512 MB (app: 256 MB, db: 256 MB)
Docker CPU:    5.2%
Uptime:        2h 15m

Top disk consumers:
  node_modules/    1.2 GB (shared)
  .hn-state/       1.0 GB
  dist/            100 MB
```

**Implementation:**
- Track resource usage in `.hn-state/<worktree>/stats.json`
- Update on worktree operations
- Query Docker stats via API
- Simple time-series data (last 24h, simple moving average)

**Tests:**
- Track disk usage
- Query Docker stats
- Handle missing Docker gracefully
- Stats history

**Files:**
- `src/cli/stats.rs` (new, ~250 lines)
- `src/monitoring.rs` (new, ~200 lines)

**Acceptance Criteria:**
- [ ] Show disk usage trends
- [ ] Show Docker resource usage
- [ ] Works without Docker
- [ ] 8+ tests

**Estimated Effort:** 3 days

---

## What's NOT in v0.5 (Deferred to v1.0)

### Interactive Mode for `hn add`
**Why deferred:** Would require making `<name>` argument optional, which is a breaking change. v1.0 is the appropriate time for breaking changes.

**Alternative for v0.5:** Add `hn add --interactive` flag that still requires name but makes other options interactive.

### Advanced Cache Tuning
**Why deferred:** Current 30s TTL works well. Need more real-world usage data to determine optimal values.

### Plugin/Extension System
**Why deferred:** Requires significant architectural changes. v1.0 feature.

### Remote Worktree Support
**Why deferred:** Complex feature requiring network protocol design. v1.0 or later.

### Enterprise Features (Teams, Permissions)
**Why deferred:** v1.0 or v2.0 feature set.

---

## Version Numbering Strategy

### v0.5.0 (This Release)
- Template management
- Enhanced testing
- Workflow state management
- Resource tracking
- **No breaking changes**

### v0.6.0 (Future - Optional)
- Additional UX improvements based on v0.5 feedback
- Performance tuning based on real-world usage
- Additional monitoring features

### v1.0.0 (Major Milestone)
**Focus:** Production stability, polish, potentially breaking changes
- Interactive mode (with breaking changes if needed)
- Comprehensive documentation overhaul
- Full audit of all features
- Performance optimization pass
- Security audit
- Potential API stabilization
- **Breaking changes allowed**

---

## Technical Improvements

### Code Quality
- Add more inline documentation
- Improve error messages based on user feedback
- Refactor duplicated code in CLI commands

### Testing Infrastructure
- Add property-based testing for fuzzy matching
- Performance regression tests
- Integration test parallelization

### Documentation
- Update all command docs with template examples
- Add workflow guide for template management
- Update BENCHMARKS.md with new baseline

---

## Success Criteria for v0.5

### Functionality
- [ ] All template management commands work (list, create, show)
- [ ] Template file copying works with variable substitution
- [ ] Workspace save/restore works reliably
- [ ] Resource tracking accurate
- [ ] 50+ new tests (35+ passing now)
- [ ] All existing 273 tests still pass

### Quality
- [ ] Zero compiler warnings (maintain current standard)
- [ ] Zero clippy warnings in production code
- [ ] All new features documented
- [ ] CHANGELOG.md updated
- [ ] Migration guide if needed (likely not)

### Performance
- [ ] No regressions from v0.4 benchmarks
- [ ] Template operations < 100ms
- [ ] Workspace restore < 5s (with Docker)

### Documentation
- [ ] README.md updated with template examples
- [ ] docs/templates.md created
- [ ] docs/workflows.md updated
- [ ] spec/v0.5.md completed (this document)
- [ ] Migration guide (docs/MIGRATING.md) updated

---

## Development Plan

### Phase 1: Critical Fix & Template Management (Week 1-2)
**Day 1 (half day):** Environment variable renaming (HNHN_* migration)
- Update src/hooks.rs (simple find/replace)
- Update all documentation
- Add tests
- **This MUST ship first to avoid confusion**

**Days 1.5-2.5:** `hn templates list` and `hn templates show`
- Implement CLI commands
- Use existing list_templates() infrastructure
- Add tests

**Days 3-5:** `hn templates create`
- Interactive wizard
- Create from scratch or current worktree
- README generation
- Tests

**Days 6-8:** Template file copying
- Implement file copying logic
- Variable substitution
- Integration with `hn add`
- Tests

**Deliverable:** Complete template management system

### Phase 2: Comprehensive Testing (Week 2-3)
**Days 9-11:** Hook testing
- 15+ comprehensive hook tests
- All hook types covered
- Edge cases and failure modes

**Days 12-14:** Docker testing
- 20+ comprehensive Docker tests
- Port allocation edge cases
- Health checks, stats, cleanup

**Deliverable:** Significantly improved test coverage

### Phase 3: Workflow Features (Week 3-4)
**Days 15-18:** Workspace state management
- Save/restore commands
- Docker integration
- Tests

**Days 19-21:** Resource tracking
- Stats command
- Monitoring infrastructure
- Tests

**Deliverable:** Enhanced workflow management

### Phase 4: Polish & Release (Week 4)
**Days 22-23:** Documentation
- Update README
- Create docs/templates.md
- Update CHANGELOG

**Day 25:** Testing & Bug Fixes
- Full regression testing
- Fix any issues found

**Day 26:** Release
- Version bump to 0.5.0
- Create release notes
- Tag and push

---

## Risk Assessment

### Low Risk
- âœ… Template listing (infrastructure exists)
- âœ… Additional testing (pure addition)
- âœ… Resource tracking (isolated feature)

### Medium Risk
- âš ï¸ Template file copying (file I/O, permissions)
  - **Mitigation:** Comprehensive testing, security validation
- âš ï¸ Workspace restore (Docker orchestration complexity)
  - **Mitigation:** Graceful failure handling, dry-run mode

### High Risk
- âŒ None identified for v0.5 scope

---

## User Feedback Integration

Based on v0.4 "Elon Musk validation" feedback:
- âœ… No shortcuts: Complete features properly
- âœ… Fix all bugs: Comprehensive testing added
- âœ… Measure performance: Maintain benchmark suite
- âœ… Accurate docs: Documentation is part of every feature

---

## Open Questions

1. **Template file copying security:** Should we sandbox template scripts?
   - **Decision needed:** v0.5 or defer to v0.6

2. **Workspace state storage format:** YAML vs JSON?
   - **Recommendation:** YAML for consistency with config files

3. **Resource tracking granularity:** How detailed should stats be?
   - **Recommendation:** Start simple (disk, Docker), add more in v0.6 based on feedback

4. **Template variable syntax:** `${VAR}` vs `{{VAR}}`?
   - **Recommendation:** `${VAR}` for shell compatibility

---

## Next Steps

1. **Review this spec** with the team (if any) or validate assumptions
2. **Create feature branch:** `claude/v0.5-template-management-<SESSION_ID>`
3. **Start with Phase 1:** Template management (highest value, existing infrastructure)
4. **Iterate quickly:** Small commits, test as you go
5. **Update this spec** as decisions are made

---

**Version:** 0.5.0-planning
**Created:** 2025-11-12
**Author:** Claude (Hannahanna AI Assistant)
**Status:** ğŸ“‹ Planning Phase

**Ready to build?** Let's start with template management! ğŸš€
